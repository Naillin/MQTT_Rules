# Приложение MQTT Rules

[English version](README.md)
[Windows](https://github.com/Naillin/MQTT_Client.git)

MQTT_Rules — это приложение, которое позволяет связывать поля Firebase/Firestore с MQTT-топиками с помощью правил.

## Установка и настройка

1. Для начала вам требуется получить секретный ключ если вы собиратесь использовать Firebase. Если вы планируете использовать Firestore то, вы должны получить `.json` файл Firebase Admin SDK и включить Cloud Firestore API для своего проекта. Ничто не мешает вам использовать обе базы данных одновременно.
2. Так же вам нужно установить `jq` в свою систему (`sudo apt install jq` или `sudo pacman -S jq` и т.д.).
3. После скрипт `create_files.sh`. Этот скрипт создаст `config.ini` для настройки программы, необходимо указать следующие данные:
   - Данные вашего MQTT-брокера (адрес, порт).
   - Логин и пароль для подключения к MQTT-брокеру.
   - URL базы данных Firebase.
   - Секретный ключ для подключения к Firebase.
   - Идентификатор проекта.
   - Путь до `.json` файла Firebase Admin SDK.
   Вместе с этим скрипт создаст два `.json` файла для хранения массива правил.
4. Затем запустите скрипт `initialization.sh`. Этот скрипт создаст и запустит демона для фоновой работы приложения. С этого момента управление осуществляется с помощью `systemctl`. Если вам требуется автоматический запуск демона при старте системы вы можете использовать команду `sudo systemctl enable mqtt-rules.service`.
5. Если вам нужно удалить MQTT_Rules используйте `stop_and_remove_service.sh`. Скрипт остановит демона и удалит его из системы, затем вы можете очистить корневую директорию приложения.

## Основные возможности

### Управление правилами

Связывайте поля базы данных Firebase/Firestore с MQTT-топиками. Правила позволяют автоматически синхронизировать данные между Firebase/Firestore и MQTT. Все правила хранятся в корне в файле `rulesFirebase.json`/`rulesFirestore.json`. (ссылки на поля Firebase следует начинать с символа `/`, то есть `/switch1/data`)
- **Создание**: Используйте скрипт add_rule.sh. Пример: `./add_rule.sh fb "path/to/field" ">" "path/to/topic"`. [Скрипт] [fb/fs] [path/to/field] [direction] [path/to/topic]. То есть - скрипт, выбор `.json` с которым связанно взаимодействие, путь до поля в базе данных, направление пермещения данных, путь до топика.
- **Листинг**: Используйте скрипт list_rules.sh. Пример: `./list_rules.sh fb`. [Скрипт] [fb/fs]. То есть - скрипт, выбор .json с которым связанно взаимодействие.
- **Удаление**: Используйте скрипт delete_rule.sh. Пример: `./delete_rule.sh fb 1,2`. [Скрипт] [fb/fs] [1.. 1,2,3..]. То есть - скрипт, выбор .json с которым связанно взаимодействие, номер правила/номера правил для удаления.
- **Удаление всего**: Используйте скрипт delete_all_rules.sh. Пример: `./delete_rule.sh`. Скрипт удалит все правила в обоих массивах `.json`.
- **ВАЖНО!!!**: Правила работают только с строчными типами в полях! Вы не можете использовать пути до колекций или корней в Firebase/Firestore! Это может приветсти к ошибкам или неожиданным результатам в работе правил! Учитывайте, что программа работает с данными в строчном представлении. Если вы создадите поле с численым типом, то после перезаписи этого поля с помощью правила, поле будет иметь строчный тип.

## Пример использования

```bash
	./create_files.sh
	sudo nano config.ini
	./add_rule.sh fb "switch1/sw1" ">" "switch1/topicSW1"
	./add_rule.sh fb "switch1/sw1" "<" "switch1/topicSW1"
	./initialization.sh
	journalctl -xu mqtt-rules.service
	sudo systemctl stop mqtt-rules.service
```
Данный фрагмент демонстрирует создание группы правил, которые реализуют синхронизацию поля базы данных `switch1/sw1` и топика `switch1/topicSW1`. В коде представлено: создание основных файлов, настройка конфигурации, добавление правил, запуск демона, чтение логов, остановка демона.

## Лицензия

MIT License.
